"use strict";define("Build/Queue-Panel",["require","exports","Build/Flux/Action","VSS/Platform/Feature","react","VSSUI/FormItem","VSSUI/PickList","VSSUI/Panel","VSSUI/TextField","Build/Flux/Store","Build/SourceProviders/Common","VSS/Core/Util/String","VSS/Core/Observable","VSSUI/Button","VSSUI/List","VSSUI/Link","VSSUI/Util","VSSUI/Observer","VSSUI/Checkbox","VSSUI/MessageCard","VSSUI/Spinner","Build/Common/Library/Resources","VSSUI/Icon","Build/Common/Library/Legacy/Components/ShelvesetAction","Build/Common/Library/Legacy/Components/BranchDropdown","Build/Common/Library/SingletonManager","Build/Common/Library/Legacy/Stores/Queue","DistributedTask/Common/Library/AgentQueueSelector","DistributedTask/Common/Library/Sources/Queue","VSS/Core/TimerManagement","VSS/Platform/FPS","VSSUI/ButtonGroup","VSSUI/Header","VSSUI/Intersection"],function(e,t,i,s,a,n,r,o,l,c,d,u,h,m,p,g,b,_,v,S,f,D,C,V,y,x,E,A,w,B,R,T,P,N){var L,k,I,O,q,H,M,U,F;L=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.AddDemandButton="Add demand",t.Resources.AddDemandPanelTitle="New demand",t.Resources.AddVariableButton="Add variable",t.Resources.AddVariablePanelTitle="New variable",t.Resources.AdvancedOptionsLabel="Advanced options",t.Resources.AgentSpecificationRequired="Selecting an agent specification is required",t.Resources.AgentPool="Agent pool",t.Resources.Back="Back",t.Resources.BranchLabel="Branch/tag",t.Resources.BuildQueuedMessage="Build #{0} has been queued.",t.Resources.CancelButtonText="Cancel",t.Resources.CloseButtonAriaLabel="Close",t.Resources.ConditionFieldLabel="Condition",t.Resources.CreateButtonText="Create",t.Resources.DeleteButtonEmptyTooltip="Delete variable",t.Resources.DeleteButtonTooltip="Delete variable '{0}'",t.Resources.DemandsEmptySecondaryText="This pipeline has no defined demands",t.Resources.DemandsLearnMore="Learn more about demands",t.Resources.DemandsManySecondaryText="{0} demands defined",t.Resources.DemandsOneSecondaryText="1 demand defined",t.Resources.DemandsTabTitle="Demands",t.Resources.DependsOn="Depends on: {0}",t.Resources.DuplicateVariableMessage="Variable '{0}' is already defined",t.Resources.EmptyDemandsDescription="You can add demands for this run.",t.Resources.EmptyDemandsVariablesLink=" Learn more.",t.Resources.EmptyVariablesDescription="You can add variables for this run.",t.Resources.EqualsCondition="equals",t.Resources.ExistsCondition="exists",t.Resources.GitSourceSelectorDescription="select the branch or commit tag",t.Resources.ListItemRoleDescription="button",t.Resources.NameFieldLabel="Name",t.Resources.NoStageDependencies="No dependencies",t.Resources.QueueButtonText="Run",t.Resources.QueuePanelDescription="Select parameters below and manually run the pipeline",t.Resources.QueuePanelTitleNoDefinition="Run pipeline",t.Resources.RequiredLabel="Required",t.Resources.StageOptionsRunAsConfigured="Run as configured",t.Resources.RunWithDiagnostics="Enable system diagnostics",t.Resources.RunWithWarningsButtonText="Run anyway",t.Resources.SaveAndRunWithWarningsButtonText="Save and run anyway",t.Resources.SaveAndQueueButtonText="Save and run",t.Resources.SaveComment="Save comment",t.Resources.SecretFieldLabel="Keep this value secret",t.Resources.SingleStagePipeline="Configuration is only available for multi-stage pipelines.",t.Resources.SkippedStagesWarning="Ensure that skipped stages do not produce any artifacts required by later stages.",t.Resources.SourceVersionLabel="Source version",t.Resources.StagesToRun="Stages to run",t.Resources.StagesToRunSecondaryText="Deselect stages you want to skip for this run",t.Resources.StartingRun="Starting run...",t.Resources.TfsGitSourceSelectorDescription="Select the branch, commit or commit tag",t.Resources.UnableToLoadStages="Unable to load the pipeline's stages.",t.Resources.UpdateButtonText="Update",t.Resources.UpdateDemandPanelTitle="Update demand",t.Resources.UseSelectedStages="Use selected stages",t.Resources.UpdateVariablePanelTitle="Update variable",t.Resources.ValueFieldLabel="Value",t.Resources.VariablesLearnMore="Learn more about variables",t.Resources.VariableRequiredNameMessage="Variable name is required",t.Resources.VariablesEmptySecondaryText="This pipeline has no defined variables",t.Resources.VariablesManySecondaryText="{0} variables defined",t.Resources.VariablesOneSecondaryText="1 variable defined",t.Resources.VariablesTabTitle="Variables",function(e){k=t.Action={},Object.defineProperty(t,"__esModule",{value:!0});t.Action.EnableDiagnosticActionCreator=class{constructor(e){this._actionHub=e.actionHub||new a}toggleEnableDiagnostic(e){this._actionHub.toggleEnableDiagnostic.invoke(e)}};class a{constructor(){this._toggleEnableDiagnostic=new i.Action}get toggleEnableDiagnostic(){return this._toggleEnableDiagnostic}}t.Action.EnableDiagnosticActionHub=a;class n{constructor(e){this._actionHub=e.actionHub||new r}queueBuild(e){e.isYaml&&s.isFeatureFlagEnabled(e.pageContext,"Build2.SkipStages",!1)?this._runPipeline(e):this._queueBuild(e)}_runPipeline(e){const t={refName:e.sourceBranch,version:e.sourceVersion},i={stagesToSkip:e.stagesToSkip,resources:{repositories:{self:t}},variables:e.variables};e.pageContext.getRestClient("IPipelinesRestClient").runPipeline(i,e.projectId,e.definitionId).then(e=>this._actionHub.buildQueued.invoke({buildId:e.id})).catch(e=>{this._actionHub.buildQueued.invoke({buildId:void 0,message:e.message,messageSeverity:"Error"})})}_queueBuild(e){const t={agentSpecification:e.agentSpecification,queue:{id:e.agentQueueId},definition:{id:e.definitionId},project:{id:e.projectId},sourceBranch:e.sourceBranch,sourceVersion:e.sourceVersion,reason:1,demands:e.demands,parameters:e.serializedVariables};e.pageContext.getRestClient("IBuildRestClient").queueBuild(t,e.projectId,e.ignoreWarnings).then(e=>this._actionHub.buildQueued.invoke({buildId:e.id})).catch(e=>{const t=n._getErrorAndWarningMessage(e);this._actionHub.buildQueued.invoke({buildId:void 0,message:t.message,messageSeverity:t.severity})})}static _getErrorAndWarningMessage(e){let t="",i="Info";if(e&&e.length>0){const s=e.filter(e=>2===e.result);s.length>0?(t=this._joinValidateResults(s),i="Error"):(t=this._joinValidateResults(e),i="Warning")}else if(e)return this._getErrorMessageFromServer(e);return{message:t,severity:i}}static _joinValidateResults(e){let t=e.map(e=>e.message);return(t=t.filter(e=>!!e)).join(",")}static _getErrorMessageFromServer(e){let t="",i="Error";if(e&&(t=e.message||""),e&&e.serverError&&e.serverError.customProperties){let s=e.serverError.customProperties.ValidationResults;if(s&&s.length>0){const e=s.filter(e=>2===e.result);t=this._joinValidateResults(e);const a=s.filter(e=>1===e.result);a&&a.length>0&&(t=this._joinValidateResults(a),i="Warning")}}else e&&e.serverError&&0===t.length&&(t=e.serverError.message||"");return{message:t,severity:i}}}t.Action.QueueBuildActionCreator=n;class r{constructor(){this._buildQueued=new i.Action}get buildQueued(){return this._buildQueued}}t.Action.QueueBuildActionHub=r;t.Action.SourceVersionActionCreator=class{constructor(e){this._actionHub=e.actionHub||new o}updateVersion(e){this._actionHub.versionUpdated.invoke(e)}updateBranch(e){this._actionHub.branchUpdated.invoke(e)}updateTag(e){this._actionHub.tagUpdated.invoke(e)}updateShelveset(e){this._actionHub.shelvesetUpdated.invoke(e)}};class o{constructor(){this._versionUpdated=new i.Action,this._branchUpdated=new i.Action,this._shelvesetUpdated=new i.Action,this._tagUpdated=new i.Action}get versionUpdated(){return this._versionUpdated}get branchUpdated(){return this._branchUpdated}get tagUpdated(){return this._tagUpdated}get shelvesetUpdated(){return this._shelvesetUpdated}}t.Action.SourceVersionActionHub=o}(),I=t.FormInputLabel={},Object.defineProperty(t,"__esModule",{value:!0}),t.FormInputLabel.FormInputLabel=(e=>{const{primaryLabel:t,secondaryLabel:i}=e;return a.createElement("div",{className:"flex-row variable-label-div"},a.createElement("div",{className:"variable-label-primary-text"},t),a.createElement("div",{className:"variable-label-secondary-text secondary-text"},i))}),function(e){O=t.DemandPanel={},Object.defineProperty(t,"__esModule",{value:!0});t.DemandPanel.DemandPanel=class extends a.Component{constructor(e){super(e),this._onKeyDown=(e=>{const t=!this._isValidName()||!this._isValidValue();"Enter"!==e.key||e.defaultPrevented||t||(this._clickOk(),e.preventDefault())}),this._onNameChanged=((e,t)=>{this.state.demand.name=t,this.setState({demand:this.state.demand})}),this._onValueChanged=((e,t)=>{this.state.demand.value=t,this.setState({demand:this.state.demand})}),this._onConditionChanged=(e=>{this.state.demand.condition=e,this.setState({demand:this.state.demand})}),this._isValidName=(()=>{const e=this.state.demand;return!(!e.name||""===e.name.trim())}),this._isValidValue=(()=>{const e=this.state.demand;return!!(1!==e.condition||e.value&&""!==e.value.trim())}),this._clickOk=(()=>{this.props.isNewDemand&&this.props.onDemandAdded?this.props.onDemandAdded(this.state.demand):!this.props.isNewDemand&&this.props.onDemandUpdated&&this.props.onDemandUpdated(this.state.demand),this.props.onDismiss()}),this.state={demand:this.props.demand}}render(){const e=this.props.isNewDemand?L.AddDemandPanelTitle:L.UpdateDemandPanelTitle,t=this.props.isNewDemand?L.CreateButtonText:L.UpdateButtonText,s=!this._isValidName()||!this._isValidValue(),n=this.props.isNewDemand?".variable-panel-demand-name":".variable-panel-demand-condition";return a.createElement(o.Panel,{backButtonProps:{subtle:!0,iconProps:{iconName:"Back"},onClick:this.props.onDismiss,ariaLabel:L.Back},onDismiss:this.props.onDismiss,titleProps:{text:e},className:"variable-panel",defaultActiveElement:n,footerButtonProps:[{text:L.CancelButtonText,onClick:this.props.onDismiss},{text:t,primary:!0,onClick:this._clickOk,disabled:s}]},a.createElement(i,{demand:this.state.demand,isNewDemand:this.props.isNewDemand,onNameChanged:this._onNameChanged,onConditionChanged:this._onConditionChanged,onValueChanged:this._onValueChanged,onKeyDown:this._onKeyDown}))}};class i extends a.Component{constructor(){super(...arguments),this._getDemandNameControl=(()=>a.createElement(n.FormItem,{className:"variable-panel-demand-name flex-grow margin-bottom-16",label:a.createElement(I.FormInputLabel,{primaryLabel:L.NameFieldLabel,secondaryLabel:L.RequiredLabel})},a.createElement(l.TextField,{ariaLabel:L.NameFieldLabel,value:this.props.demand.name,className:"primary-text",ref:e=>{this._nameTextFieldRef=e},onChange:this.props.onNameChanged,disabled:!this.props.isNewDemand,required:!0}))),this._getDemandConditionControl=(()=>a.createElement("div",{className:"variable-condition-container flex-grow margin-bottom-16"},a.createElement("label",{className:"flex-grow flex-row margin-bottom-8"},L.ConditionFieldLabel),a.createElement(r.PickListDropdown,{selectOnFocus:!0,ariaLabelFormat:L.ConditionFieldLabel,selectedItems:this._getSelectedCondition(),className:"variable-panel-demand-condition flex-grow primary-text",ref:e=>{this._conditionDropDownRef=e},getPickListItems:this._getConditions,getListItem:e=>({key:e&&e.key?e.key.toString():"",name:e?e.name:""}),onSelectionChanged:e=>this.props.onConditionChanged(e.selectedItems[0].key)}))),this._getDemandValueControl=(()=>a.createElement(n.FormItem,{className:"flex-grow margin-bottom-16",label:a.createElement(I.FormInputLabel,{primaryLabel:L.ValueFieldLabel,secondaryLabel:L.RequiredLabel})},a.createElement(l.TextField,{value:this.props.demand.value,className:"primary-text",onChange:this.props.onValueChanged,required:!0}))),this._getSelectedCondition=(()=>1===this.props.demand.condition?[{key:this.props.demand.condition,name:L.EqualsCondition}]:[{key:this.props.demand.condition,name:L.ExistsCondition}]),this._getConditions=(()=>[{key:1,name:L.EqualsCondition},{key:0,name:L.ExistsCondition}])}render(){return a.createElement("div",{className:"variable-panel-content flex-grow",onKeyDown:this.props.onKeyDown},this._getDemandNameControl(),this._getDemandConditionControl(),1===this.props.demand.condition&&this._getDemandValueControl())}componentDidMount(){this.props.isNewDemand?(this._nameTextFieldRef&&this._nameTextFieldRef.focus(),this._nameTextFieldRef&&this._nameTextFieldRef.select()):this._conditionDropDownRef&&this._conditionDropDownRef.focus()}}}(),function(e){q=t.StoresQueueBuild={},Object.defineProperty(t,"__esModule",{value:!0});const i="ms.vss-build-web.pipeline-stages-data-provider",s="{0} -equals {1}",a="equals",n="refs/heads/",r="refs/tags/",o="refs/";class l extends c.Store{constructor(e){super(),this._sourceVersion="",this._shelvesetName="",this.updateDefinition=((e,t,i,s,a)=>{s||(this._buildDefinition=void 0),this._definitionId=e,this._runtimeVariables=new h.ObservableArray(this._createRuntimeVariablesArray(t)),this._sourceBranch=i||"",this._sourceVersion="",this._shelvesetName="",this._sourceTag="",this._selectedQueue={},this._buildRepository=a||{},this._enableDiagnostic=!1,this._stageOptions.removeAll()}),this.updateBuildDefinition=((e,t)=>{const i=e&&e.repository?e.repository.defaultBranch:"";this._buildDefinition=e,e&&e.id&&this.updateDefinition(e.id,t,i,!0,e.repository)}),this.fetchBuildDefinition=(()=>this._buildDefinition&&this._buildDefinition.id===this._definitionId?Promise.resolve(this._buildDefinition):this._buildClient.getDefinition(this._projectId,this._definitionId).then(e=>(this._buildDefinition=e,this._buildDefinition))),this.fetchUpdatedDefaultBranch=(()=>this._buildClient.getDefinition(this._projectId,this._definitionId).then(e=>e.repository.defaultBranch)),this.fetchDemands=(()=>{this._demands?this._demands.removeAll():this._demands=new h.ObservableArray([]),this.fetchBuildDefinition().then(e=>{const t=this._convertSerializedDemandToDemandData(e.demands);this._demands.value=t},e=>{console.log("failed to retrieve build definition: "+e)})}),this.fetchPipelineStages=(()=>{this._stageOptions.removeAll();const e={pipelineId:this._definitionId.toString(),sourceBranch:this.getSourceBranch(),sourceVersion:this.getSourceVersion()};return new Promise(t=>{const s=this._pageContext.getService("IVssContributionService");s.getDataAsync(i,e,!0).then(e=>{if(e){const i={};e.forEach(e=>i[e.refName.toLowerCase()]=e.name),this._stageOptions.value=e.map(e=>({name:e.name,refName:e.refName,dependsOn:(e.dependsOn||[]).map(e=>i[e.toLowerCase()]),skip:!1})),t(this._stageOptions.value)}else{const e=s.getDataProviderExceptions()[i],a=e&&e.message;console.log("Failed to retrieve pipeline stages: "+a),t([])}})})}),this.getVariables=(()=>this._runtimeVariables),this._createRuntimeVariablesArray=(e=>{let t=0,i=[];return e&&e.length>0&&e.forEach(e=>{i.push({index:t,name:e.name,value:e.variable.value,isSecret:e.variable.isSecret,disableDelete:e.variable.disableDelete}),t++}),i}),this._removeDuplicateDemands=(e=>{for(var t=0;t<e.length;++t)for(var i=t+1;i<e.length;++i)this._areEqualDemands(e[t],e[i])&&e.splice(i--,1)}),this._areEqualDemands=((e,t)=>{if(e.name===t.name&&e.condition===t.condition){if(1!==e.condition)return!0;if(e.value===t.value)return!0}return!1}),this._isGit=(e=>{const t=e.toLowerCase();return t===d.RepositoryTypes.Bitbucket.toLowerCase()||t===d.RepositoryTypes.ExternalGit.toLowerCase()||t===d.RepositoryTypes.GitHub.toLowerCase()||t===d.RepositoryTypes.GitHubEnterprise.toLowerCase()||t===d.RepositoryTypes.TfsGit.toLowerCase()}),this._handleQueueSelected=(e=>{this._selectedQueue=e,this.fetchDemands(),this.emitChanged()}),this._handleBranchUpdated=(e=>{this._resetPipelineSources(),this._sourceBranch=e,this._stageOptions.removeAll(),this.emitChanged()}),this._handleTagUpdated=(e=>{this._resetPipelineSources(),this._sourceTag=e,this._stageOptions.removeAll(),this.emitChanged()}),this._handleShelvesetUpdated=(e=>{this._shelvesetName=e,this.emitChanged()}),this._handleToggleEnableDiagnostic=(e=>{this._enableDiagnostic=e,this.emitChanged()}),this._handleVersionUpdated=(e=>{this._resetPipelineSources(),this._sourceVersion=e,this._stageOptions.removeAll(),this.emitChanged()}),this._resetPipelineSources=(()=>{this._sourceBranch="",this._sourceTag="",this._sourceVersion=""}),this.updateVariable=(e=>{this._runtimeVariables.change(e.index,e)}),this.addVariable=(e=>{this._runtimeVariables.push(e)}),this.deleteVariable=(e=>{this._runtimeVariables.splice(e,1)}),this.addDemand=(e=>{this._demands.push(e)}),this.deleteDemand=(e=>{this._demands.splice(e,1)}),this.updateDemand=(e=>{this._demands.change(e.index,e)}),this.updateStageOptions=(e=>{this._stageOptions.value=e.map(e=>Object.assign({},e))}),this._pageContext=e.pageContext,this._definitionId=e.definitionId,e.buildDefinition&&(this._buildDefinition=e.buildDefinition),this._sourceBranch=e.sourceBranch||"",this._projectId=e.projectId,this._sourceVersionActionHub=e.sourceVersionActionHub,this._shelvesetPickerActiobHub=e.shelvesetPickerActiobHub,this._buildRepository=e.buildRepository,this._queueActionHub=e.queueActionHub,this._runtimeVariables=new h.ObservableArray(this._createRuntimeVariablesArray(e.runtimeVariables)),this._enableDiagnosticActionHub=e.enableDiagnosticActionHub,this._sourceVersionActionHub.versionUpdated.addListener(this._handleVersionUpdated),this._sourceVersionActionHub.branchUpdated.addListener(this._handleBranchUpdated),this._sourceVersionActionHub.tagUpdated.addListener(this._handleTagUpdated),this._shelvesetPickerActiobHub.pickerDismissed.addListener(this._handleShelvesetUpdated),this._enableDiagnosticActionHub.toggleEnableDiagnostic.addListener(this._handleToggleEnableDiagnostic),this._queueActionHub.queueSelected.addListener(this._handleQueueSelected),this._demands=new h.ObservableArray([]),this._stageOptions=new h.ObservableArray([]),this._buildClient=this._pageContext.getRestClient("IBuildRestClient")}getRunTimeVariables(){let e={};return this._runtimeVariables.value.forEach(t=>{t.name&&t.name.trim()&&(!t.isSecret||t.value)&&(e[t.name]={value:t.value,isSecret:t.isSecret})}),e}getSerializedVariables(){let e={};return this._runtimeVariables.value.forEach(t=>{t.name&&t.name.trim()&&(!t.isSecret||t.value)&&(e[t.name]=t.value)}),this._enableDiagnostic&&(e["system.debug"]="true",e["agent.diagnostic"]="true"),JSON.stringify(e)}getDemandsValues(){return this._convertDemandDataToSerializedDemand()}get demands(){return this._demands}get runtimeVariables(){return this._runtimeVariables}get stageOptions(){return this._stageOptions}get skippedStageNames(){return this._stageOptions.value.filter(e=>e.skip).map(e=>e.refName)}getSourceBranch(){if(this._buildRepository&&this._buildRepository.type&&this._isGit(this._buildRepository.type)){if(this._sourceBranch&&!this._sourceBranch.startsWith(n)&&!this._sourceBranch.startsWith(o))return n+this._sourceBranch;if(this._sourceTag&&!this._sourceTag.startsWith(r))return r+this._sourceTag}return this._sourceBranch}getSourceVersion(){return this._sourceVersion}getShelvesetName(){return this._shelvesetName}getSelectedQueue(){return this._selectedQueue}getEnableDiagnosticState(){return this._enableDiagnostic}getShelvesetPickerActionHub(){return this._shelvesetPickerActiobHub}getSourceControlSelectorActionHub(){return this._sourceVersionActionHub}getEnableDiagnosticActionHub(){return this._enableDiagnosticActionHub}dispose(){this._sourceVersionActionHub.versionUpdated.removeListener(this._handleVersionUpdated),this._sourceVersionActionHub.branchUpdated.removeListener(this._handleBranchUpdated),this._sourceVersionActionHub.tagUpdated.removeListener(this._handleTagUpdated),this._shelvesetPickerActiobHub.pickerDismissed.removeListener(this._handleBranchUpdated),this._queueActionHub.queueSelected.removeListener(this._handleQueueSelected)}_convertDemandDataToSerializedDemand(){let e=[];return(this._demands.value||[]).forEach(t=>{switch(t.condition){case 0:e.push(t.name.trim());break;case 1:e.push(u.format(s,t.name.trim(),t.value.trim()))}}),e}_convertSerializedDemandToDemandData(e){let t=[];if(e&&e.length>0){e.forEach((e,i)=>{let s={index:i,name:"",condition:0,value:""},n=l._demandRegex.exec(e)||{};n&&(s.name=n[1]?n[1]:"",s.value=n[4]?n[4]:"",n[3]&&n[3].length>0&&a===n[3].toLocaleLowerCase()?s.condition=1:s.condition=0),t.push(s),i++})}return t}}var m,p;l.key="build-commands-queue-build-store",l._demandRegex=/^([^\s]+)(\s+\-([^\s]+)\s+(.*))?/,t.StoresQueueBuild.QueueBuildStore=l,function(e){e.IconColumnIndex=0,e.NameColumnIndex=1,e.ConditionColumnIndex=2,e.ValueColumnIndex=3,e.DeleteColumnIndex=4}(m||(m={})),function(e){e.IconColumnIndex=0,e.NameColumnIndex=1,e.ValueColumnIndex=2,e.SecretColumnIndex=3,e.DeleteColumnIndex=4}(p||(p={}))}(),function(e){H=t.DemandsControllerView={},Object.defineProperty(t,"__esModule",{value:!0});const i="https://go.microsoft.com/fwlink/?linkid=2087182";t.DemandsControllerView.DemandsControllerView=class extends a.Component{constructor(e){super(e),this._listSelection=new p.ListSelection,this._onKeyDown=(e=>{if("delete"===e.key.toLowerCase()&&this._listSelection.selectedCount>0){const t=this._listSelection.value[0].beginIndex;this.props.store.deleteDemand(t),e.preventDefault()}}),this._renderRow=((e,t,i)=>{const s=t.name?u.format(L.DeleteButtonTooltip,t.name):L.DeleteButtonEmptyTooltip,n=1===t.condition?"= "+t.value:L.ExistsCondition,r=b.getSafeId(this.c_hiddenAriaDivId);return a.createElement(p.ListItem,{key:"list-item"+e,index:e,details:i},a.createElement("div",{className:"variable-row flex-grow flex-row h-scroll-hidden padding-horizontal-20"},a.createElement("div",{className:"flex-column justify-center","aria-describedby":r},a.createElement("span",{className:"text-ellipsis primary-text","aria-label":t.name},t.name),a.createElement("span",{className:"font-size text-ellipsis secondary-text","aria-label":n},n),a.createElement("div",{"aria-label":L.ListItemRoleDescription,id:r})),a.createElement("span",{className:"flex-grow flex-row justify-end"},a.createElement("div",{className:"flex-column justify-center"},a.createElement(m.Button,{subtle:!0,className:"bolt-list-cell-content-reveal margin-right-4",iconProps:{iconName:"Delete"},onClick:t=>{this.props.store.deleteDemand(e),t.preventDefault()},tooltipProps:{text:s}})))))}),this._createDemand=(()=>{const e={index:this.props.store.demands.length};this._renderDemandPanel(e,!0)}),this._updateDemand=((e,t)=>{this._renderDemandPanel(Object.assign({},t.data),!1)}),this._renderDemandPanel=((e,t)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout(i=>a.createElement(O.DemandPanel,{demand:e,isNewDemand:t,onDismiss:i,onDemandAdded:e=>this.props.store.addDemand(e),onDemandUpdated:e=>this.props.store.updateDemand(e)}))}),this.c_hiddenAriaDivId="hiddenAriaDiv",this._itemProvider=this.props.store.demands}render(){return a.createElement(o.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:this.props.pipelineName,escDismiss:!0,footerButtonProps:[{text:L.AddDemandButton,primary:!0,onClick:this._createDemand}],onDismiss:this.props.onDismiss,titleProps:{text:L.DemandsTabTitle}},a.createElement("div",{className:"variables-list-container v-scroll-auto custom-scrollbar"},a.createElement("div",{onKeyDown:this._onKeyDown},a.createElement(p.List,{itemProvider:this._itemProvider,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._updateDemand})),a.createElement(_.Observer,{demands:this._itemProvider},e=>0===e.demands.length?a.createElement("span",{className:"flex-row margin-vertical-8 padding-horizontal-20 primary-text"},a.createElement("label",{className:"margin-right-4"},L.EmptyDemandsDescription),a.createElement(g.Link,{href:i,ariaLabel:L.DemandsLearnMore},L.EmptyDemandsVariablesLink)):null)))}}}(),function(e){M=t.StageOptionsControllerView={},Object.defineProperty(t,"__esModule",{value:!0});t.StageOptionsControllerView.StageOptionsControllerView=class extends a.Component{constructor(e){super(e),this._renderRow=((e,t,i)=>{const s=b.getSafeId(this.c_hiddenAriaDivId);return a.createElement(p.ListItem,{key:"list-item"+e,index:e,details:i},a.createElement("div",{className:"flex-grow flex-row h-scroll-hidden padding-horizontal-20 padding-vertical-8"},a.createElement("div",{className:"flex-column margin-right-8 justify-center"},a.createElement(v.Checkbox,{checked:!t.skip})),a.createElement("div",{className:"flex-column justify-center margin-left-4","aria-describedby":s},a.createElement("span",{className:"text-ellipsis primary-text","aria-label":t.name},t.name),a.createElement("span",{className:"font-size text-ellipsis secondary-text"},0===t.dependsOn.length?L.NoStageDependencies:u.format(L.DependsOn,t.dependsOn.join(", "))),a.createElement("div",{"aria-label":L.ListItemRoleDescription,id:s}))))}),this._getMessageCard=((e,t)=>a.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},a.createElement(S.MessageCard,{severity:e},t))),this._initializeStageOptions=(()=>{const e=this.props.store.stageOptions;0===e.length?(this._loadingStages.value=!0,this._stageOptions.removeAll(),this.props.store.fetchPipelineStages().then(e=>{this._copyStageOptions(e),this._loadingStages.value=!1})):this._copyStageOptions(e.value)}),this._onStageSelectionChanged=((e,t)=>{const i=this._stageOptions.value[e];i.skip=t,this._stageOptions.change(e,i)}),this._submitStageSelection=(()=>{this.props.store.updateStageOptions(this._stageOptions.value),this.props.onDismiss()}),this.c_hiddenAriaDivId="hiddenAriaDiv",this._loadingStages=new h.ObservableValue(!1),this._stageOptions=new h.ObservableArray([]),this._initializeStageOptions()}render(){return a.createElement(o.CustomPanel,{onDismiss:this.props.onDismiss},a.createElement(o.PanelHeader,{backButtonProps:{onClick:this.props.onDismiss},titleProps:{text:L.StagesToRun},description:L.StagesToRunSecondaryText,onDismiss:this.props.onDismiss}),a.createElement(o.PanelContent,{className:"queue-panel-child no-padding"},a.createElement("div",{className:"custom-scrollbar flex-column flex-grow h-scroll-hidden"},a.createElement(_.Observer,{loading:this._loadingStages},e=>e.loading?a.createElement("div",null,a.createElement(f.Spinner,{className:"queue-build-spinner"})):this._displayStageOptions()))),a.createElement(_.Observer,{stages:this._stageOptions},e=>a.createElement(o.PanelFooter,{buttonProps:[{text:L.CancelButtonText,onClick:this.props.onDismiss},{text:L.UseSelectedStages,primary:!0,disabled:e.stages.length<=1||this._skippedStages.length===e.stages.length,onClick:this._submitStageSelection}]})))}_displayStageOptions(){return a.createElement(_.Observer,{stages:this._stageOptions},e=>{const t=e.stages.length;return a.createElement("div",{className:"v-scroll-auto custom-scrollbar"},t>1&&a.createElement("div",null,a.createElement(p.ScrollableList,{itemProvider:this._stageOptions,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,onActivate:(e,t)=>this._onStageSelectionChanged(t.index,!t.data.skip)}),this._skippedStages.length>0&&this._getMessageCard("Warning",L.SkippedStagesWarning)),1===t&&this._getMessageCard("Info",L.SingleStagePipeline),t<1&&this._getMessageCard("Error",L.UnableToLoadStages))})}_copyStageOptions(e){this._stageOptions.value=e.map(e=>Object.assign({},e))}get _skippedStages(){return this._stageOptions.value.filter(e=>e.skip)}}}(),function(e){U=t.VariablePanel={},Object.defineProperty(t,"__esModule",{value:!0});t.VariablePanel.VariablePanel=class extends a.Component{constructor(e){super(e),this._onKeyDown=(e=>{const t=this._getDuplicateValidationMessage(),i=!this._isValidVariableName()||""!==t;"Enter"!==e.key||e.defaultPrevented||i||(this._clickOk(),e.preventDefault())}),this._isValidVariableName=(()=>{const e=this.state.variable.name;return!!e&&""!==e.trim()}),this._getDuplicateValidationMessage=(()=>{const e=this.state.variable,t=e.name?e.name.trim().toLocaleLowerCase():"";return this._getDuplicateVariableNamesMap()[t]>1?u.format(L.DuplicateVariableMessage,e.name):""}),this._getDuplicateVariableNamesMap=(()=>{let e={};return this.props.runtimeVariables?((this.props.isNewVariable?this.props.runtimeVariables.value.concat([this.state.variable]):this.props.runtimeVariables.value).forEach((t,i)=>{if(t&&t.name){let i=t.name?t.name.trim().toLocaleLowerCase():"";e.hasOwnProperty(i)?e[i]++:e[i]=1}}),e):e}),this._clickOk=(()=>{this.props.isNewVariable&&this.props.onVariableAdded?this.props.onVariableAdded(this.state.variable):!this.props.isNewVariable&&this.props.onVariableUpdated&&this.props.onVariableUpdated(this.state.variable),this.props.onDismiss()}),this._onNameChanged=((e,t)=>{this.state.variable.name=t,this.setState({variable:this.state.variable})}),this._onValueChanged=((e,t)=>{this.state.variable.value=t,this.setState({variable:this.state.variable})}),this.state={variable:this.props.variable}}render(){const e=this.props.isNewVariable?L.AddVariablePanelTitle:L.UpdateVariablePanelTitle,t=this.props.isNewVariable?L.CreateButtonText:L.UpdateButtonText,s=this._getDuplicateValidationMessage(),n=!this._isValidVariableName()||""!==s,r=this.props.isNewVariable?".variable-panel-variable-name-input":".variable-panel-variable-value-input";return a.createElement(o.Panel,{backButtonProps:{subtle:!0,iconProps:{iconName:"Back"},ariaLabel:L.Back,onClick:this.props.onDismiss},onDismiss:this.props.onDismiss,escDismiss:!0,titleProps:{text:e},className:"variable-panel",defaultActiveElement:r,footerButtonProps:[{text:L.CancelButtonText,onClick:this.props.onDismiss},{text:t,primary:!0,onClick:this._clickOk,disabled:n}]},a.createElement(i,{variable:this.props.variable,isNewVariable:this.props.isNewVariable,validationMessage:s,onNameChanged:this._onNameChanged,onValueChanged:this._onValueChanged,onKeyDown:this._onKeyDown}))}};class i extends a.Component{constructor(e){super(e),this._getVariableNameControl=(()=>a.createElement(n.FormItem,{className:"flex-grow margin-bottom-16",label:a.createElement(I.FormInputLabel,{primaryLabel:L.NameFieldLabel,secondaryLabel:L.RequiredLabel}),error:""!==this.props.validationMessage,message:this.props.validationMessage},a.createElement(l.TextField,{ariaLabel:L.NameFieldLabel,ref:e=>{this._nameTextFieldRef=e},value:this.props.variable.name,inputClassName:"variable-panel-variable-name-input",onChange:this.props.onNameChanged,disabled:this.props.variable.disableDelete,required:!0}))),this._getVariableValueControl=(()=>{const e=this.props.variable,t=e.isSecret?"password":"text",i=e.isSecret&&null===e.value?this.c_secretVariableFillerText:e.value;return a.createElement(n.FormItem,{label:L.ValueFieldLabel,className:"flex-grow margin-bottom-8"},a.createElement(l.TextField,{value:i,inputClassName:"variable-panel-variable-value-input",ref:e=>{this._valueTextFieldRef=e},inputType:t,onChange:this.props.onValueChanged}))}),this._getVariableSecretControl=(()=>{const e=!!this.props.variable&&this.props.variable.isSecret;return a.createElement(v.Checkbox,{className:"no-h-padding",label:L.SecretFieldLabel,checked:e,disabled:!0})}),this.c_secretVariableFillerText="*****",this.state={variable:this.props.variable}}render(){return a.createElement("div",{className:"variable-panel-content flex-grow",onKeyDown:this.props.onKeyDown},this._getVariableNameControl(),this._getVariableValueControl(),!this.props.isNewVariable&&this.props.variable&&this.props.variable.isSecret&&this._getVariableSecretControl())}componentDidMount(){this.props.isNewVariable?(this._nameTextFieldRef&&this._nameTextFieldRef.focus(),this._nameTextFieldRef&&this._nameTextFieldRef.select()):(this._valueTextFieldRef&&this._valueTextFieldRef.focus(),this._valueTextFieldRef&&this._valueTextFieldRef.select())}}}(),function(e){F=t.VariablesControllerView={},Object.defineProperty(t,"__esModule",{value:!0});const i="https://go.microsoft.com/fwlink/?linkid=2087183";t.VariablesControllerView.VariablesControllerView=class extends a.Component{constructor(e){super(e),this._listSelection=new p.ListSelection,this._onKeyDown=(e=>{if("delete"===e.key.toLowerCase()&&this._listSelection.selectedCount>0){const t=this._listSelection.value[0].beginIndex;this._itemProvider.value[t].disableDelete||(this.props.store.deleteVariable(t),e.preventDefault())}}),this._renderRow=((e,t,i)=>{const s=t.name?u.format(L.DeleteButtonTooltip,t.name):L.DeleteButtonEmptyTooltip,n=t.isSecret?D.VariableSecretMask:"= "+t.value,r=t.isSecret?"Lock":"Variable",o=b.getSafeId(this.c_hiddenAriaDivId);return a.createElement(p.ListItem,{key:"list-item"+e,index:e,details:i},a.createElement("div",{className:"variable-row flex-grow flex-row h-scroll-hidden padding-horizontal-20"},a.createElement(C.Icon,{iconName:r,size:"medium",className:"variable-icon margin-right-8"}),a.createElement("div",{className:"flex-column justify-center margin-left-4","aria-describedby":o},a.createElement("span",{className:"text-ellipsis primary-text","aria-label":t.name},t.name),a.createElement("span",{className:"font-size text-ellipsis secondary-text","aria-label":n},n),a.createElement("div",{"aria-label":L.ListItemRoleDescription,id:o})),a.createElement("span",{className:"flex-grow flex-row justify-end"},!t.disableDelete&&a.createElement("div",{className:"flex-column justify-center"},a.createElement(m.Button,{subtle:!0,className:"bolt-list-cell-content-reveal margin-right-4",iconProps:{iconName:"Delete"},onClick:t=>{this.props.store.deleteVariable(e),t.preventDefault()},tooltipProps:{text:s}})))))}),this._createVariable=(()=>{const e={index:this.props.store.runtimeVariables.length};this._renderVariablePanel(e,!0)}),this._updateVariable=((e,t)=>{this._renderVariablePanel(Object.assign({},t.data),!1)}),this._renderVariablePanel=((e,t)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout(i=>a.createElement(U.VariablePanel,{isNewVariable:t,onDismiss:i,onVariableAdded:e=>this.props.store.addVariable(e),onVariableUpdated:e=>this.props.store.updateVariable(e),runtimeVariables:this.props.store.runtimeVariables,variable:e}))}),this.c_hiddenAriaDivId="hiddenAriaDiv",this._itemProvider=this.props.store.runtimeVariables}render(){return a.createElement(o.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:this.props.pipelineName,escDismiss:!0,footerButtonProps:[{text:L.AddVariableButton,primary:!0,onClick:this._createVariable}],onDismiss:this.props.onDismiss,titleProps:{text:L.VariablesTabTitle}},a.createElement("div",{className:"variables-list-container v-scroll-auto custom-scrollbar"},a.createElement("div",{onKeyDown:this._onKeyDown},a.createElement(p.List,{itemProvider:this._itemProvider,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._updateVariable})),a.createElement(_.Observer,{variables:this._itemProvider},e=>0===e.variables.length?a.createElement("span",{className:"flex-row margin-vertical-8 padding-horizontal-20 primary-text"},a.createElement("label",{className:"margin-right-4"},L.EmptyVariablesDescription),a.createElement(g.Link,{href:i,ariaLabel:L.VariablesLearnMore},L.EmptyDemandsVariablesLink)):null)))}}}(),function(e){t.QueuePanel={},Object.defineProperty(t,"__esModule",{value:!0});const i="refs/heads/",n="refs/tags/";class r extends a.Component{constructor(e){super(e),this._advancedOptionsItemProvider=new h.ObservableArray([]),this._advancedOptionsListSelection=new p.ListSelection,this._showPanel=!1,this._showError=!1,this._errorMessage="",this._enableDiagnostic=!1,this._agentSpecificationServiceErrorMessage=new h.ObservableValue(""),this._agentSpecifications=new h.ObservableArray,this._isLoadingAgentSpecifications=new h.ObservableValue(!1),this._saveCommentText=new h.ObservableValue(""),this._queueActionPending=new h.ObservableValue(!1),this._timerManagement=new B.TimerManagement,this._pendingOverlayTimeoutId=0,this._isTfsGit=!1,this._commentTextFieldRef=a.createRef(),this._overflowing=!1,this._observingOverflow=!1,this._intersectionCallbackRegistered=!1,this._renderAdvancedOptionRow=((e,t,i)=>a.createElement(p.ListItem,{key:"list-item"+e,index:e,details:i},a.createElement("div",{className:"flex-grow flex-row padding-horizontal-20"},a.createElement("div",{className:"flex-column flex-grow padding-vertical-8"},a.createElement("span",{className:"primary-text"},t.primaryText),a.createElement("span",{className:"font-size-ms secondary-text"},t.secondaryText)),a.createElement(C.Icon,{iconName:"ChevronRightMed",size:"medium"})))),this._onFetchRepoError=(e=>{this._showError=!0,this._errorMessage=e,this._messageSeverity="Error",this.setState(this._getState())}),this._onSaveCommentChange=((e,t)=>{this._saveCommentText.value=t}),this._branchSelected=(e=>{this._sourceVersionActionCreator.updateBranch(e)}),this._versionSelected=(e=>{this._sourceVersionActionCreator.updateVersion(e)}),this._tagSelected=(e=>{this._sourceVersionActionCreator.updateTag(e)}),this._shelvesetSelected=(e=>{this._sourceVersionActionCreator.updateShelveset(e)}),this._dismissPanel=(()=>{this._showPanel=!1,this.setState(this._getState()),this.props.onDismiss()}),this._storeChanged=(()=>{this._selectedAgentQueue=this._queueBuildStore.getSelectedQueue(),this._selectedBranch=this._normalizeBranchName(this._queueBuildStore.getSourceBranch()),this._sourceVersion=this._queueBuildStore.getSourceVersion(),this._shelvesetName=this._queueBuildStore.getShelvesetName(),this._currentCommit=this._queueBuildStore.getSourceVersion(),this._enableDiagnostic=this._queueBuildStore.getEnableDiagnosticState(),this.setState(this._getState())}),this._queueStoreChanged=(()=>{this._queues=this._queueStore.getQueues()||[],this.setState(this._getState())}),this._queueBuild=(()=>{this._pendingOverlayTimeoutId=this._timerManagement.setTimeout(this._showOverlay,250),this._runButtonDisabled=!0,this.setState({runButtonDisabled:this._runButtonDisabled});let e=Promise.resolve(this._buildDefinition),t=!1;this.props.isSaveEnabled&&this.props.onSave&&(e=this.props.onSave(this._saveCommentText.value),t=!0);const i=this._queueBuildStore.getShelvesetName();e.then(e=>{const s=this._queueStore.getSelectedQueue(),a=s?s.id:-1,n={isYaml:this._isYamlBuildDefinition(),definitionId:this.props.definitionId,agentQueueId:a,ignoreWarnings:"Warning"===this.state.messageSeverity,projectId:this.props.projectId,pageContext:this.props.pageContext,variables:this._queueBuildStore.getRunTimeVariables(),serializedVariables:this._queueBuildStore.getSerializedVariables(),demands:this._queueBuildStore.getDemandsValues(),sourceBranch:i||this._queueBuildStore.getSourceBranch(),sourceVersion:this._queueBuildStore.getSourceVersion(),stagesToSkip:this._queueBuildStore.skippedStageNames,agentSpecification:this._selectedAgentSpecification};t&&!i&&e&&e.repository&&e.repository.type.toLowerCase()===d.RepositoryTypes.TfsVersionControl.toLowerCase()&&(n.sourceBranch=e.repository.defaultBranch),this._actionCreator.queueBuild(n)}).catch(e=>{this._timerManagement.clearTimeout(this._pendingOverlayTimeoutId);let t="";e&&(t=e.message||e),this._showError=!0,this._errorMessage=t,this._messageSeverity="Error",this.setState(this._getState())})}),this._onSelectedQueueChanged=(e=>{e&&(this._selectedAgentSpecification=void 0,this._queueActionCreator.selectQueue(e),this._updateAgentSpecifications(e))}),this._onToggleEnableDiagnostic=((e,t)=>{this._enableDiagnosticActionCreator.toggleEnableDiagnostic(t)}),this._onSelectedAgentSpecificationChanged=(e=>{this._selectedAgentSpecification=e,this._agentSpecificationServiceErrorMessage.value="",this._runButtonDisabled=!1,this.setState(this._getState())}),this._showOverlay=(()=>{this._showPanel&&(this._queueActionPending.value=!0)}),this._handleBuildQueued=(e=>{this._publishQueueBuildTelemetry(),this._timerManagement.clearTimeout(this._pendingOverlayTimeoutId),e.buildId?this._onSuccess(e.buildId):(this._queueActionPending.value=!1,this._showError=!0,this._errorMessage=e.message||"",this._messageSeverity=e.messageSeverity||"Info",this._runButtonDisabled=!1,this.setState(this._getState()))}),this._onSuccess=(e=>{const t=this.props.pageContext.getService("IBuildLinkingService").getBuildUrl(e);R.onClickFPS(this.props.pageContext,t,!0)}),this._observeElement=(e=>{e&&this._intersectionContext&&!this._observingOverflow&&(this._intersectionContext.observe(e),this._observedElement=e,this._observingOverflow=!0)}),this._onIntersect=(e=>{let t=e.find(e=>e.target===this._observedElement);if(t){let e=Math.round(t.rootBounds.bottom)<Math.round(t.boundingClientRect.bottom);e!==this._overflowing&&(this._overflowing=e,this.setState(this._getState()))}}),this._registerAdvancedOptions=(()=>{const e=this._isYamlBuildDefinition(),t=[];t.push({component:F.VariablesControllerView,primaryText:L.VariablesTabTitle,props:{pageContext:this.props.pageContext,pipelineName:this._buildDefinition.name,store:this._queueBuildStore},secondaryText:a.createElement(_.Observer,{variables:this._queueBuildStore.runtimeVariables},e=>a.createElement("span",null,0===e.variables.length?L.VariablesEmptySecondaryText:1===e.variables.length?L.VariablesOneSecondaryText:u.format(L.VariablesManySecondaryText,e.variables.length)))}),e||t.push({component:H.DemandsControllerView,primaryText:L.DemandsTabTitle,props:{pageContext:this.props.pageContext,pipelineName:this._buildDefinition.name,store:this._queueBuildStore},secondaryText:a.createElement(_.Observer,{demands:this._queueBuildStore.demands},e=>a.createElement("span",null,0===e.demands.length?L.DemandsEmptySecondaryText:1===e.demands.length?L.DemandsOneSecondaryText:u.format(L.DemandsManySecondaryText,e.demands.length)))}),e&&s.isFeatureFlagEnabled(this.props.pageContext,"Build2.SkipStages",!1)&&t.push({component:M.StageOptionsControllerView,primaryText:L.StagesToRun,props:{pageContext:this.props.pageContext,store:this._queueBuildStore,pipelineId:this.props.definitionId},secondaryText:a.createElement(_.Observer,{stageOptions:this._queueBuildStore.stageOptions},e=>{const t=e.stageOptions.filter(e=>e.skip).length,i=e.stageOptions.filter(e=>!e.skip).map(e=>e.name);return a.createElement("span",null,0===t?L.StageOptionsRunAsConfigured:i.join(", "))})}),this._advancedOptionsItemProvider.value=t}),this._onAdvancedOptionSelected=((e,t)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout(e=>a.createElement(t.data.component,Object.assign({},t.data.props,{onDismiss:e})))}),this._getState=(()=>({showPanel:this._showPanel,showError:this._showError,errorMessage:this._errorMessage,messageSeverity:this._messageSeverity,isRootPath:!1,queues:this._queues,selectedAgentQueue:this._selectedAgentQueue,sourceVersion:this._sourceVersion,shelvesetName:this._shelvesetName,currentCommit:this._currentCommit,selectedBranch:this._selectedBranch,agentSpecifications:this._agentSpecifications?this._agentSpecifications.value:[],selectedAgentSpecification:this._selectedAgentSpecification,isLoadingAgentSpecifications:!!this._isLoadingAgentSpecifications&&this._isLoadingAgentSpecifications.value,runButtonDisabled:this._runButtonDisabled,enableDiagnostic:this._enableDiagnostic,overflowing:this._overflowing})),this._showPanel=e.showPanel,this._runButtonDisabled=!0,this._selectedBranch=this._normalizeBranchName(this.props.sourceBranch),this.props.runtimeVariables&&this.props.runtimeVariables.length>0&&this.props.runtimeVariables.forEach(e=>{e.variable.disableDelete=void 0===e.variable.disableDelete||e.variable.disableDelete}),this._isTfsGit=!(!this.props.buildRepository||!this.props.buildRepository.type||this.props.buildRepository.type.toLowerCase()!==d.RepositoryTypes.TfsGit.toLowerCase()),this._actionHub=new k.QueueBuildActionHub,this._actionCreator=new k.QueueBuildActionCreator({actionHub:this._actionHub});let t=x.getSingletonManager().get(E.QueueStore.key);t?this._queues=t.getQueues():(this._queueActionHub=new E.QueueActionHub,t=new E.QueueStore({pageContext:e.pageContext,project:e.projectId,actionHub:this._queueActionHub}),x.getSingletonManager().add(E.QueueStore.key,t)),this._queueStore=t,this._queueActionHub=t.getActionHub(),this._queueActionCreator=new E.QueueActionCreator({actionHub:this._queueActionHub,source:new w.QueueSource({pageContext:this.props.pageContext,project:this.props.projectId})});let i=x.getSingletonManager().get(q.QueueBuildStore.key);i?(this._sourceVersionActionHub=i.getSourceControlSelectorActionHub(),this._shelvesetPickerActionHub=i.getShelvesetPickerActionHub(),this._enableDiagnosticActionHub=i.getEnableDiagnosticActionHub(),e.buildDefinition?i.updateBuildDefinition(e.buildDefinition,e.runtimeVariables):i.updateDefinition(e.definitionId,e.runtimeVariables,e.sourceBranch,!1,e.buildRepository)):(this._sourceVersionActionHub=new k.SourceVersionActionHub,this._shelvesetPickerActionHub=new V.ShelvesetPickerActionHub,this._enableDiagnosticActionHub=new k.EnableDiagnosticActionHub,i=new q.QueueBuildStore({pageContext:e.pageContext,projectId:e.projectId,definitionId:e.definitionId,buildDefinition:e.buildDefinition,sourceBranch:e.sourceBranch,runtimeVariables:this.props.runtimeVariables,sourceVersionActionHub:this._sourceVersionActionHub,shelvesetPickerActiobHub:this._shelvesetPickerActionHub,enableDiagnosticActionHub:this._enableDiagnosticActionHub,queueActionHub:this._queueActionHub,buildRepository:e.buildRepository}),x.getSingletonManager().add(q.QueueBuildStore.key,i)),this._queueBuildStore=i,this._sourceVersionActionCreator=new k.SourceVersionActionCreator({actionHub:this._sourceVersionActionHub}),this._enableDiagnosticActionCreator=new k.EnableDiagnosticActionCreator({actionHub:this._enableDiagnosticActionHub}),this.state=this._getState(),this._queueBuildStore.fetchDemands(),this._setupAgentSpecifications().then(()=>this._registerAdvancedOptions())}async _setupAgentSpecifications(){return this._agentSpecificationService=this.props.pageContext.getService("IAgentSpecificationService"),this._queueBuildStore.fetchBuildDefinition().then(e=>{this._buildDefinition=e;const t=e.queue;if(t&&e.project&&(this._selectedAgentQueue={id:t.id,name:t.name,pool:t.pool,projectId:e.project.id}),this._queueActionCreator.selectQueue(this._selectedAgentQueue),!this._isYamlBuildDefinition()){this._updateAgentSpecifications(this._selectedAgentQueue);const t=e.process;t&&t.target&&t.target.agentSpecification&&(this._selectedAgentSpecification=t.target.agentSpecification)}this._runButtonDisabled=!1,this.setState(this._getState())}).catch(e=>{e&&e.message&&(this._errorMessage=e.message,this._showError=!0,this.setState(this._getState()))})}_isYamlBuildDefinition(){return!(!this._buildDefinition||!this._buildDefinition.process)&&this._buildDefinition.process.type===r.YamlProcessType}_updateAgentSpecifications(e){this._isLoadingAgentSpecifications.value=!0,this._runButtonDisabled=!0,this.setState(this._getState()),this._agentSpecificationService.getAgentSpecificationsByQueue(e).then(e=>{this._agentSpecificationServiceErrorMessage.value="",this._agentSpecifications.removeAll(),e&&e.length>0&&(this._agentSpecifications.push(...e),this._selectedAgentSpecification||(this._agentSpecificationServiceErrorMessage.value=L.AgentSpecificationRequired)),this._runButtonDisabled=!!this._agentSpecificationServiceErrorMessage.value}).catch(e=>{this._agentSpecifications.removeAll(),e&&e.message&&(this._agentSpecificationServiceErrorMessage.value=e.message)}).then(()=>{this._isLoadingAgentSpecifications.value=!1,this.setState(this._getState())})}render(){const e=this._isYamlBuildDefinition(),t=!this._buildDefinition,i=this._getRunButtonText(),s=[];return s.push({id:"queue-panel-close-button",onActivate:this._dismissPanel,ariaLabel:L.CloseButtonAriaLabel,iconProps:{iconName:"Cancel"},subtle:!0,role:"button"}),a.createElement(_.Observer,{isPanelOpen:this._showPanel,queueActionPending:this._queueActionPending},n=>n.isPanelOpen?a.createElement(o.CustomPanel,{className:"queue-panel flex-column h-scroll-hidden",lightDismiss:!n.queueActionPending,onDismiss:this._dismissPanel},a.createElement(P.Header,{className:"bolt-panel-header title-m",commandBarItems:s},L.QueuePanelTitleNoDefinition,a.createElement("div",{className:"secondary-text fontSizeM"},L.QueuePanelDescription)),a.createElement(o.PanelContent,null,a.createElement("div",{className:"flex-column flex-grow"},this.state.showError&&a.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},a.createElement(S.MessageCard,{severity:this.state.messageSeverity},this.state.errorMessage)),n.isPanelOpen&&!t&&a.createElement(a.Fragment,null,a.createElement("div",{className:"padding-horizontal-20 padding-vertical-4"},!e&&a.createElement(a.Fragment,null,this._getSaveCommentContent(),this._getAgentPools()),this._getBranchControl()),a.createElement(N.Intersection,null,a.createElement("div",{className:b.css(this.state.overflowing&&"bottom-border","custom-scrollbar flex-column flex-grow v-scroll-auto")},a.createElement(N.IntersectionContext.Consumer,null,e=>(this._intersectionContext=e,a.createElement("div",{className:"flex-column flex-grow",ref:e=>this._observeElement(e)},a.createElement("label",{className:"title-s padding-horizontal-20 margin-bottom-16"},L.AdvancedOptionsLabel),a.createElement(p.List,{itemProvider:this._advancedOptionsItemProvider,onActivate:this._onAdvancedOptionSelected,renderRow:this._renderAdvancedOptionRow,selection:this._advancedOptionsListSelection,singleClickActivation:!0,width:"100%"}))))))),t&&n.isPanelOpen&&a.createElement(f.Spinner,{className:"queue-build-spinner"}))),a.createElement(o.PanelFooter,{className:"flex-row"},a.createElement(v.Checkbox,{label:L.RunWithDiagnostics,className:"flex-grow margin-right-8",onChange:this._onToggleEnableDiagnostic,checked:this.state.enableDiagnostic}),a.createElement(T.ButtonGroup,{className:"bolt-panel-footer-buttons"},a.createElement(m.Button,{text:L.CancelButtonText,onClick:this._dismissPanel}),a.createElement(m.Button,{text:i,primary:!0,onClick:this._queueBuild,disabled:this.state.runButtonDisabled}))),n.queueActionPending&&a.createElement(o.PanelOverlay,{overlayContent:a.createElement(f.Spinner,{label:L.StartingRun})})):null)}_getSaveCommentContent(){return this.props.isSaveEnabled?a.createElement(a.Fragment,null,a.createElement("div",{className:"flex-column"},a.createElement("label",{className:"label"},L.SaveComment),a.createElement(l.TextField,{ariaLabel:L.SaveComment,value:this._saveCommentText,onChange:this._onSaveCommentChange,ref:this._commentTextFieldRef})),a.createElement("hr",null)):null}_getAgentPools(){return a.createElement(_.Observer,{agentSpecifications:this._agentSpecifications,errorMessage:this._agentSpecificationServiceErrorMessage,isLoading:this._isLoadingAgentSpecifications},e=>a.createElement(A.AgentQueueSelector,{agentSpecifications:[...e.agentSpecifications],autoFocus:!this.props.isSaveEnabled,isLoadingAgentSpecifications:e.isLoading,selectedAgentSpecification:this.state.selectedAgentSpecification,onAgentSpecificationSelected:this._onSelectedAgentSpecificationChanged,agentSpecificationErrorMessage:e.errorMessage,label:L.AgentPool,agentQueues:this.state.queues,selectedQueue:this._selectedAgentQueue,onAgentChanged:this._onSelectedQueueChanged}))}_getBranchControl(){const e=this._buildDefinition?this._buildDefinition.repository:void 0,t=e&&e.properties&&e.properties.connectedServiceId||"",i=this.props.buildRepository.type===d.RepositoryTypes.TfsVersionControl?L.SourceVersionLabel:L.BranchLabel,s=this.state.sourceVersion,n=!!this._buildDefinition&&this._buildDefinition.process.type===r.YamlProcessType,o=this._isTfsGit?L.TfsGitSourceSelectorDescription:L.GitSourceSelectorDescription;return a.createElement(y.BranchDropdown,{className:"flex-column label margin-bottom-16",ariaLabel:i,label:i,autoFocus:n&&!this.props.isSaveEnabled,repositoryType:this.props.buildRepository.type,repositoryId:this.props.buildRepository.id,defaultBranch:this.state.selectedBranch,description:o,connectionId:t,sourceVersion:s,shelvesetName:this.state.shelvesetName,currentCommit:this.state.currentCommit,onBranchSelected:this._branchSelected,onError:this._onFetchRepoError,onVersionSelected:this._versionSelected,onTagSelected:this._tagSelected,onShelvesetSelected:this._shelvesetSelected,viewCommits:!0,viewTags:!0,pageContext:this.props.pageContext,actionHub:this._shelvesetPickerActionHub,isDrodownFullWidth:!0})}_getRunButtonText(){return this.props.isSaveEnabled?"Warning"!==this.state.messageSeverity?L.SaveAndQueueButtonText:L.SaveAndRunWithWarningsButtonText:"Warning"!==this.state.messageSeverity?L.QueueButtonText:L.RunWithWarningsButtonText}componentDidMount(){this._actionHub.buildQueued.addListener(this._handleBuildQueued),this._queueStore.addListener(this._queueStoreChanged),this._queueBuildStore.addListener(this._storeChanged)}componentDidUpdate(){this._intersectionContext&&!this._intersectionCallbackRegistered&&(this._intersectionContext.register(this._onIntersect),this._intersectionCallbackRegistered=!0),this.props.isSaveEnabled&&this._commentTextFieldRef&&this._commentTextFieldRef.current&&this._commentTextFieldRef.current.focus()}componentWillUnmount(){this._actionHub.buildQueued.removeListener(this._handleBuildQueued),this._queueStore.removeListener(this._queueStoreChanged),this._queueBuildStore.removeListener(this._storeChanged),this._timerManagement.dispose(),this._intersectionContext&&this._intersectionContext.unregister(this._onIntersect)}_publishQueueBuildTelemetry(){const e=this._queueBuildStore.getDemandsValues(),t=this._queueBuildStore.getVariables(),i={};i.variablesCount=t?t.length:0,i.customDemandsCount=e?e.length:0,i.buildDefinitionId=this.props.definitionId,this.props.pageContext.getService("IVssTelemetryService").publishEvent("Build","queueBuild",i)}_normalizeBranchName(e){return e&&e.startsWith(i)?e.substr(i.length):e&&e.startsWith(n)?e.substr(n.length):e||""}}r.YamlProcessType=2,t.QueuePanel.QueuePanel=r}()},["Resources","Action","FormInputLabel","DemandPanel","Stores/QueueBuild","DemandsControllerView","StageOptionsControllerView","VariablePanel","VariablesControllerView","QueuePanel"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.queue-panel"}}));